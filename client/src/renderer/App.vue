<template>
  <!-- Ê†πÂÆπÂô®ÔºåÂåÖÂê´Êï¥‰∏™Â∫îÁî®ÁïåÈù¢ -->
  <div class="app-container">
    <!-- Ëá™ÂÆö‰πâÊ†áÈ¢òÊ†èÂå∫Âüü -->
    <div class="custom-titlebar">
      <!-- Ê†áÈ¢òÊ†èÂ∑¶‰æßÈÉ®ÂàÜÔºöÂõæÊ†á„ÄÅÊ†áÈ¢òÂíåÁä∂ÊÄÅ -->
      <div class="titlebar-left">
        <img src="@/asserts/logo.png" alt="Everything AI Chat Logo" class="app-icon" />
        <div class="app-title">{{ $t('app.title') }}</div>
        <!-- EverythingÊúçÂä°ÁöÑËøûÊé•Áä∂ÊÄÅÊåáÁ§∫Âô® -->
        <div class="everything-status">
          <!-- Áä∂ÊÄÅÁÇπÔºåÊ†πÊçÆËøûÊé•Áä∂ÊÄÅÊîπÂèòÈ¢úËâ≤ -->
          <div class="status-dot" :class="everythingStatusClass"></div>
          <!-- Áä∂ÊÄÅÊñáÊú¨ÔºåÊòæÁ§∫ËøûÊé•Áä∂ÊÄÅ -->
          <span class="status-text">{{ everythingStatusText }}</span>
        </div>
      </div>
      <!-- Á™óÂè£ÊéßÂà∂ÊåâÈíÆÔºöÊúÄÂ∞èÂåñ„ÄÅÊúÄÂ§ßÂåñ„ÄÅÂÖ≥Èó≠ -->
      <div class="window-controls">
        <button @click="minimizeWindow" class="control-button minimize" :title="$t('window.minimize')">
          <span>‚àí</span>
        </button>
        <button @click="toggleMaximize" class="control-button maximize" :title="isMaximized ? $t('window.restore') : $t('window.maximize')">
          <!-- Ê†πÊçÆÁ™óÂè£ÊòØÂê¶ÊúÄÂ§ßÂåñÊòæÁ§∫‰∏çÂêåÂõæÊ†á -->
          <span>{{ isMaximized ? '‚ßâ' : '‚ñ°' }}</span>
        </button>
        <button @click="closeWindow" class="control-button close" :title="$t('window.close')">
          <span>√ó</span>
        </button>
      </div>
    </div>

    <!-- ‰∏ªË¶ÅÊêúÁ¥¢ÂäüËÉΩÂå∫Âüü -->
    <div class="search-section">
      <div class="search-container">
        <div class="search-row">
          <div class="search-title">{{ $t('search.title') }}</div>
          <div class="search-input-wrapper">
            <!-- ÊêúÁ¥¢ËæìÂÖ•Ê°Ü -->
            <input v-model="searchQuery" @keydown.enter="performSearch" @keydown.down.prevent="navigateHistory(1)"
              @keydown.up.prevent="navigateHistory(-1)" @focus="showHistory = true" @blur="hideHistoryDelayed"
              class="search-input" :placeholder="$t('search.placeholder')" :disabled="isSearching"
              ref="searchInput" />
            <!-- ÊêúÁ¥¢ÊåâÈíÆ -->
            <button @click="performSearch" :disabled="isSearching || !searchQuery.trim()" class="search-button"
              :class="{ 'searching': isSearching }">
              {{ isSearching ? $t('search.searching') : $t('search.button') }}
            </button>

            <!-- ÊêúÁ¥¢ÂéÜÂè≤‰∏ãÊãâÂàóË°® -->
            <div v-if="showHistory && filteredHistory.length > 0" class="search-history">
              <!-- ÈÅçÂéÜÂπ∂ÊòæÁ§∫ËøáÊª§ÂêéÁöÑÊêúÁ¥¢ÂéÜÂè≤ -->
              <div v-for="(item, index) in filteredHistory" :key="item.id" @click="selectHistoryItem(item)"
                :class="['search-history-item', { active: historySelectedIndex === index }]">
                <div class="search-history-query">{{ item.query }}</div>
                <!-- Â¶ÇÊûúAIËΩ¨Êç¢ÂêéÁöÑÊü•ËØ¢‰∏éÂéüÂßãÊü•ËØ¢‰∏çÂêåÔºåÂàôÊòæÁ§∫ÂÆÉ -->
                <div v-if="item.everything_query !== item.query" class="search-history-everything">
                  {{ item.everything_query }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ë∞ÉËØïÁ™óÂè£ÊéßÂà∂Âå∫Âüü -->
    <div v-if="debugConfig.enableStreamDebug" class="debug-controls-bar">
      <div class="debug-info">
        <span class="debug-status">ü§ñ AIÂìçÂ∫îË∞ÉËØï</span>
      </div>
      <div class="debug-actions">
        <button @click="openDebugWindow" class="debug-action-button" title="ÊâìÂºÄË∞ÉËØïÁ™óÂè£">
          <span class="button-icon">üìä</span>
          ÊâìÂºÄË∞ÉËØïÁ™óÂè£
        </button>
        <button @click="clearDebugOutput" class="debug-action-button" title="Ê∏ÖÁ©∫Ë∞ÉËØïËæìÂá∫">
          <span class="button-icon">üóëÔ∏è</span>
          Ê∏ÖÁ©∫
        </button>
      </div>
    </div>

    <!-- ÁªìÊûúÊòæÁ§∫Âå∫Âüü -->
    <div class="results-section">
      <!-- ‰ΩøÁî® <template> ËøõË°åÊù°‰ª∂Ê∏≤ÊüìÂàÜÁªÑÔºå‰ªÖÂú®ÊúâÊêúÁ¥¢ÁªìÊûúÊó∂ÊòæÁ§∫ÂÜÖÈÉ®ÊâÄÊúâÂÜÖÂÆπ -->
      <template v-if="searchResults.length > 0">
        <!-- ÁªìÊûúÂ§¥ÈÉ®‰ø°ÊÅØÂíåÊìç‰ΩúÊåâÈíÆ -->
        <div class="results-header">
          <div class="results-info">
            <!-- ÊòæÁ§∫ÊâæÂà∞ÁöÑÊñá‰ª∂Êï∞Èáè -->
            <div class="results-count">
              {{ $t('search.found', { count: searchResults.length.toLocaleString() }) }}
            </div>
            <!-- Â¶ÇÊûúAIËΩ¨Êç¢‰∫ÜÊü•ËØ¢ÔºåÂàôÊòæÁ§∫ÂÆûÈôÖ‰ΩøÁî®ÁöÑEverythingÊü•ËØ¢ËØ≠Âè• -->
            <div v-if="lastEverythingQuery && lastEverythingQuery !== lastSearchQuery" class="everything-query">
              {{ $t('search.query', { query: lastEverythingQuery }) }}: <code>{{ lastEverythingQuery }}</code>
            </div>
          </div>
          <div class="results-actions">
            <!-- ÂØºÂá∫ÁªìÊûúÊåâÈíÆ -->
            <button @click="exportResults" class="action-button">
              <span class="button-icon">üì§</span>
              {{ $t('search.export') }}
            </button>
            <!-- Ê∏ÖÁ©∫ÁªìÊûúÊåâÈíÆ -->
            <button @click="clearResults" class="action-button">
              <span class="button-icon">üóëÔ∏è</span>
              {{ $t('search.clear') }}
            </button>
          </div>
        </div>

        <!-- Êñá‰ª∂ÂàóË°® -->
        <div class="file-list">
          <!-- Ë°®Â§¥ÂÆπÂô®ÔºåÁî®‰∫éÊ®™ÂêëÊªöÂä®ÂêåÊ≠• -->
          <div class="file-list-header-container" ref="fileListHeader">
            <!-- Êñá‰ª∂ÂàóË°®ÁöÑË°®Â§¥ÔºåÁÇπÂáªÂèØËøõË°åÊéíÂ∫è -->
            <div class="file-list-header" :class="{ dragging: isDragging }" :style="getHeaderStyle">
            <div @click="sortBy('name')" :class="['file-list-column', 'col-name', 'sortable', getSortClass('name')]" :style="getColumnStyle('name')">
              {{ $t('fileList.columns.name') }}
              <div class="column-resizer" @mousedown="startColumnResize('name', $event)"></div>
            </div>
            <div @click="sortBy('path')" :class="['file-list-column', 'col-path', 'sortable', getSortClass('path')]" :style="getColumnStyle('path')">
              {{ $t('fileList.columns.path') }}
              <div class="column-resizer" @mousedown="startColumnResize('path', $event)"></div>
            </div>
            <div @click="sortBy('size')" :class="['file-list-column', 'col-size', 'sortable', getSortClass('size')]" :style="getColumnStyle('size')">
              {{ $t('fileList.columns.size') }}
              <div class="column-resizer" @mousedown="startColumnResize('size', $event)"></div>
            </div>
            <div @click="sortBy('modified')" :class="['file-list-column', 'col-modified', 'sortable', getSortClass('modified')]" :style="getColumnStyle('modified')">
              {{ $t('fileList.columns.modified') }}
              <div class="column-resizer" @mousedown="startColumnResize('modified', $event)"></div>
            </div>
            <!-- ‰ª•‰∏ãÂàóÊ†πÊçÆÈÖçÁΩÆÂä®ÊÄÅÊòæÁ§∫ -->
            <div v-if="displayFields.created" @click="sortBy('created')" :class="['file-list-column', 'col-created', 'sortable', getSortClass('created')]" :style="getColumnStyle('created')">
              {{ $t('fileList.columns.created') }}
              <div class="column-resizer" @mousedown="startColumnResize('created', $event)"></div>
            </div>
            <div v-if="displayFields.accessed" @click="sortBy('accessed')" :class="['file-list-column', 'col-accessed', 'sortable', getSortClass('accessed')]" :style="getColumnStyle('accessed')">
              {{ $t('fileList.columns.accessed') }}
              <div class="column-resizer" @mousedown="startColumnResize('accessed', $event)"></div>
            </div>
            <div v-if="displayFields.attributes" @click="sortBy('attributes')" :class="['file-list-column', 'col-attributes', 'sortable', getSortClass('attributes')]" :style="getColumnStyle('attributes')">
              {{ $t('fileList.columns.attributes') }}
              <div class="column-resizer" @mousedown="startColumnResize('attributes', $event)"></div>
            </div>
            <div v-if="displayFields.run_count" @click="sortBy('run_count')" :class="['file-list-column', 'col-run-count', 'sortable', getSortClass('run_count')]" :style="getColumnStyle('run_count')">
              {{ $t('fileList.columns.runCount') }}
              <div class="column-resizer" @mousedown="startColumnResize('run_count', $event)"></div>
            </div>
            <div @click="sortBy('extension')" :class="['file-list-column', 'col-type', 'sortable', getSortClass('extension')]" :style="getColumnStyle('type')">
              {{ $t('fileList.columns.type') }}
            </div>
            </div>
          </div>

          <!-- Êñá‰ª∂ÂàóË°®ÁöÑ‰∏ª‰ΩìÂÜÖÂÆπÔºåÈÅçÂéÜÊéíÂ∫èÂêéÁöÑÁªìÊûú -->
          <div class="file-list-body" ref="fileListBody">
            <div v-for="file in sortedResults" :key="file.path" @click="openFile(file)"
              @contextmenu.prevent="showFileContextMenu(file, $event)" class="file-row">
              <div class="file-cell col-name" :style="getColumnStyle('name')">
                <span class="file-icon">{{ getFileIcon(file.extension) }}</span>
                <span class="file-name">{{ getDisplayFileName(file) }}</span>
              </div>
              <div class="file-cell col-path" :style="getColumnStyle('path')"><span class="file-path">{{ file.directory }}</span></div>
              <div class="file-cell col-size" :style="getColumnStyle('size')"><span class="file-size">
                  {{ formatFileSize(file.size) }}
                </span></div>
              <div class="file-cell col-modified" :style="getColumnStyle('modified')"><span class="file-modified">
                  {{ formatDate(file.modified) }}
                </span>
              </div>
              <!-- ‰ª•‰∏ãÂçïÂÖÉÊ†ºÊ†πÊçÆÈÖçÁΩÆÂä®ÊÄÅÊòæÁ§∫ -->
              <div v-if="displayFields.created" class="file-cell col-created" :style="getColumnStyle('created')"><span class="file-created">{{
                formatDate(file.created) }}</span></div>
              <div v-if="displayFields.accessed" class="file-cell col-accessed" :style="getColumnStyle('accessed')"><span class="file-accessed">{{
                formatDate(file.accessed) }}</span></div>
              <div v-if="displayFields.attributes" class="file-cell col-attributes" :style="getColumnStyle('attributes')"><span class="file-attributes">{{
                file.attributes || '-' }}</span></div>
              <div v-if="displayFields.run_count" class="file-cell col-run-count" :style="getColumnStyle('run_count')"><span class="file-run-count">{{
                file.run_count || 0 }}</span></div>
              <div class="file-cell col-type" :style="getColumnStyle('type')"><span class="file-type">{{ file.extension || 'FILE' }}
                </span></div>
            </div>
          </div>
        </div>
      </template>

      <!-- ÂΩìÊ≤°ÊúâÊêúÁ¥¢ÁªìÊûúÊó∂ÔºåÊ≠§Âå∫ÂüüÂ∞ÜÊ†πÊçÆ‰∏çÂêåÁä∂ÊÄÅÊòæÁ§∫ÂØπÂ∫îÂÜÖÂÆπ -->
      <div v-else class="state-container">
        <!-- Áä∂ÊÄÅ0: ‰ºòÂÖàÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ -->
        <div v-if="showSuccessMessage" class="success-state">
          <div class="success-icon">‚úÖ</div>
          <div class="success-message">{{ showSuccessMessage }}</div>
        </div>

        <!-- Áä∂ÊÄÅ1: ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ -->
        <div v-else-if="errorMessage" class="error-state">
          <div class="error-icon">‚ö†Ô∏è</div>
          <div class="error-message">{{ errorMessage }}</div>
          <!-- ÂÖÅËÆ∏Áî®Êà∑Ê∏ÖÈô§ÈîôËØØ‰ø°ÊÅØ -->
          <button @click="clearError" class="action-button" style="margin-top: 15px;">{{ $t('messages.info.ok') }}</button>
        </div>

        <!-- Áä∂ÊÄÅ2: Â¶ÇÊûúÊ≤°ÊúâÈîôËØØÔºåÂàôÊ£ÄÊü•ÊòØÂê¶Ê≠£Âú®ÊêúÁ¥¢ÔºåÊòæÁ§∫Âä†ËΩΩÂä®Áîª -->
        <div v-else-if="isSearching" class="loading-state">
          <div class="loading-spinner"></div>
          <div class="loading-text">{{ $t('search.searching') }}</div>
        </div>

        <!-- Áä∂ÊÄÅ3: Â¶ÇÊûúÊêúÁ¥¢ÂÆåÊàê‰ΩÜÊ≤°ÊúâÁªìÊûúÔºåÊòæÁ§∫‚ÄúÊú™ÊâæÂà∞Êñá‰ª∂‚Äù -->
        <div v-else-if="hasSearched" class="empty-state">
          <div class="empty-state-icon">üìÅ</div>
          <div class="empty-state-text">{{ $t('search.noResults') }}</div>
          <div class="empty-state-subtext">{{ $t('search.noResultsHint') }}</div>
        </div>

        <!-- Áä∂ÊÄÅ4: Â¶ÇÊûú‰ª•‰∏äÈÉΩ‰∏çÊòØÔºàÂç≥ÂàùÂßãÁä∂ÊÄÅÔºâÔºåÊòæÁ§∫Ê¨¢ËøéÂíå‰ΩøÁî®ÊèêÁ§∫ -->
        <div v-else class="empty-state">
          <div class="empty-state-icon">‚ú®üîç‚ú®</div>
          <div class="empty-state-text">{{ $t('search.welcome') }}</div>
          <div class="empty-state-subtext">{{ $t('search.welcomeHint') }}</div>
          <div class="search-suggestions">
            <div class="suggestion-title">{{ $t('search.suggestions.title') }}</div>
            <div class="suggestion-items">
              <span class="suggestion-item" @click="trySuggestion($t('search.suggestions.today_images'))">{{ $t('search.suggestions.today_images') }}</span>
              <span class="suggestion-item" @click="trySuggestion($t('search.suggestions.large_videos'))">{{ $t('search.suggestions.large_videos') }}</span>
              <span class="suggestion-item" @click="trySuggestion($t('search.suggestions.recent_docs'))">{{ $t('search.suggestions.recent_docs') }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Êõ¥Êñ∞ÈÄöÁü•ÂºπÁ™ó -->
    <div v-if="showUpdateNotification && updateInfo" class="update-notification">
      <div class="update-notification-content">
        <div class="update-header">
          <div class="update-icon">üöÄ</div>
          <div class="update-title">ÂèëÁé∞Êñ∞ÁâàÊú¨</div>
          <button @click="closeUpdateNotification" class="update-close-btn">√ó</button>
        </div>
        <div class="update-body">
          <div class="update-version-info">
            <div class="version-line">
              <span class="version-label">ÂΩìÂâçÁâàÊú¨:</span>
              <span class="version-current">v{{ updateInfo.currentVersion }}</span>
            </div>
            <div class="version-line">
              <span class="version-label">ÊúÄÊñ∞ÁâàÊú¨:</span>
              <span class="version-latest">v{{ updateInfo.latestVersion }}</span>
            </div>
          </div>
          <div v-if="updateInfo.releaseNotes" class="update-notes">
            <div class="notes-title">Êõ¥Êñ∞ÂÜÖÂÆπ:</div>
            <div class="notes-content">{{ updateInfo.releaseNotes.substring(0, 200) }}{{ updateInfo.releaseNotes.length > 200 ? '...' : '' }}</div>
          </div>
        </div>
        <div class="update-actions">
          <button @click="downloadUpdate" class="update-btn primary">
            <span class="btn-icon">‚¨áÔ∏è</span>
            Á´ãÂç≥‰∏ãËΩΩ
          </button>
          <button @click="remindLater" class="update-btn secondary">
            <span class="btn-icon">‚è∞</span>
            Á®çÂêéÊèêÈÜí
          </button>
          <button @click="ignoreVersion" class="update-btn tertiary">
            <span class="btn-icon">‚úñÔ∏è</span>
            ÂøΩÁï•
          </button>
        </div>
        <div class="update-publish-time" v-if="updateInfo.publishedAt">
          ÂèëÂ∏ÉÊó∂Èó¥: {{ new Date(updateInfo.publishedAt).toLocaleDateString('zh-CN') }}
        </div>
      </div>
    </div>

    <!-- Â∫ïÈÉ®Áä∂ÊÄÅÊ†è -->
    <div class="status-bar">
      <div class="status-left">
        <span class="status-text">{{ isSearching ? $t('status.searching') : $t('status.ready') }}</span>
        <span v-if="everythingConnected" class="status-separator">|</span>
        <!-- Ê≠§Â§ÑÂèØ‰ª•Á°¨ÁºñÁ†ÅÁâàÊú¨Âè∑ÔºåÊàñ‰ªéÂêéÁ´ØÂä®ÊÄÅËé∑Âèñ -->
        <span v-if="everythingConnected" class="status-text">Everything v1.4.1</span>
      </div>
      <div class="status-right">
        <!-- ÊòæÁ§∫‰∏ä‰∏ÄÊ¨°ÊêúÁ¥¢ÁöÑËÄóÊó∂ -->
        <span v-if="searchDuration > 0" class="status-text">{{ $t('search.duration', { duration: (searchDuration / 1000).toFixed(2) }) }}
        </span>
        <!-- ÊâìÂºÄËÆæÁΩÆÂØπËØùÊ°ÜÁöÑÊåâÈíÆ -->
        <button @click="showConfigDialog = true" class="status-settings-button" :title="$t('settings.title')">‚öôÔ∏è</button>
      </div>
    </div>

    <!-- ÈÖçÁΩÆÂØπËØùÊ°ÜÁªÑ‰ª∂ÔºåÈÄöËøá v-if ÊéßÂà∂ÊòæÁ§∫ÂíåÈöêËóè -->
    <ConfigDialog v-if="showConfigDialog" @close="showConfigDialog = false" />
  </div>
</template>

<script>
import { ref, reactive, computed, watch, onMounted, onBeforeUnmount, nextTick } from 'vue';
import ConfigDialog from './components/ConfigDialog.vue';

// --- ‰ºòÂåñÁÇπ: Â∞ÜÁ∫ØËæÖÂä©ÂáΩÊï∞ÁßªÂà∞ setup Â§ñÈÉ® ---
// Ëøô‰∫õÂáΩÊï∞‰∏ç‰æùËµñ‰∫éÁªÑ‰ª∂ÁöÑÂìçÂ∫îÂºèÁä∂ÊÄÅÔºåÂ∞ÜÂÖ∂ÁßªÂá∫ÂèØ‰ª•‰Ωø setup ÂáΩÊï∞Êõ¥Êï¥Ê¥ÅÔºå‰πü‰æø‰∫éÂçïÁã¨ÊµãËØïÊàñÂ§çÁî®„ÄÇ

/**
 * Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
 * @param {number|string} size - Êñá‰ª∂Â≠óËäÇÊï∞
 * @returns {string} Ê†ºÂºèÂåñÂêéÁöÑÂ§ßÂ∞èÂ≠óÁ¨¶‰∏≤ÔºåÂ¶Ç "1.2 MB"
 */
const formatFileSize = (size) => {
  if (!size) return '';
  const bytes = parseInt(size);
  if (isNaN(bytes) || bytes === 0) return '0 B';
  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  return `${parseFloat((bytes / Math.pow(1024, i)).toFixed(i === 0 ? 0 : 1))} ${units[i]}`;
};

/**
 * Ê†ºÂºèÂåñÊó•ÊúüÊó∂Èó¥Â≠óÁ¨¶‰∏≤
 * @param {string} dateString - ISO Ê†ºÂºèÁöÑÊó•ÊúüÂ≠óÁ¨¶‰∏≤
 * @returns {string} Êú¨Âú∞ÂåñÁöÑÊó•ÊúüÊó∂Èó¥Â≠óÁ¨¶‰∏≤ÔºåÂ¶Ç "2025/08/23 13:11"
 */
const formatDate = (dateString) => {
  if (!dateString) return '';
  try {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    });
  } catch { return dateString; }
};

/**
 * Ê†πÊçÆÊñá‰ª∂Êâ©Â±ïÂêçËé∑ÂèñÂØπÂ∫îÁöÑ Emoji ÂõæÊ†á
 * @param {string} extension - Êñá‰ª∂Êâ©Â±ïÂêç
 * @returns {string} ‰ª£Ë°®Êñá‰ª∂Á±ªÂûãÁöÑ Emoji
 */
const getFileIcon = (extension) => {
  const ext = extension?.toLowerCase() || '';
  const iconMap = {
    // ÊñáÊ°£Á±ªÂûã
    'pdf': 'üìÑ', 'doc': 'üìÑ', 'docx': 'üìÑ', 'txt': 'üìù', 'rtf': 'üìù',
    'xls': 'üìä', 'xlsx': 'üìä', 'csv': 'üìä',
    'ppt': 'üìà', 'pptx': 'üìà',
    // ÂõæÁâáÁ±ªÂûã
    'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'bmp': 'üñºÔ∏è', 'svg': 'üñºÔ∏è', 'webp': 'üñºÔ∏è', 'ico': 'üñºÔ∏è',
    // ËßÜÈ¢ëÁ±ªÂûã
    'mp4': 'üé¨', 'avi': 'üé¨', 'mkv': 'üé¨', 'mov': 'üé¨', 'wmv': 'üé¨', 'flv': 'üé¨', 'webm': 'üé¨',
    // Èü≥È¢ëÁ±ªÂûã
    'mp3': 'üéµ', 'wav': 'üéµ', 'flac': 'üéµ', 'aac': 'üéµ', 'ogg': 'üéµ', 'm4a': 'üéµ',
    // ÂéãÁº©Êñá‰ª∂
    'zip': 'üì¶', 'rar': 'üì¶', '7z': 'üì¶', 'tar': 'üì¶', 'gz': 'üì¶',
    // ‰ª£Á†ÅÊñá‰ª∂
    'js': 'üíª', 'ts': 'üíª', 'html': 'üíª', 'css': 'üíª', 'py': 'üíª', 'java': 'üíª', 'cpp': 'üíª',
    'c': 'üíª', 'php': 'üíª', 'go': 'üíª', 'rs': 'üíª', 'vue': 'üíª', 'jsx': 'üíª', 'tsx': 'üíª',
    // ÂèØÊâßË°åÊñá‰ª∂
    'exe': '‚öôÔ∏è', 'msi': '‚öôÔ∏è', 'deb': '‚öôÔ∏è', 'rpm': '‚öôÔ∏è', 'dmg': '‚öôÔ∏è',
    // Â≠ó‰ΩìÊñá‰ª∂
    'ttf': 'üî§', 'otf': 'üî§', 'woff': 'üî§', 'woff2': 'üî§',
    // ÂÖ∂‰ªñ
    'json': 'üìã', 'xml': 'üìã', 'log': 'üìú'
  };
  return iconMap[ext] || 'üìÑ'; // ÈªòËÆ§ËøîÂõûÈÄöÁî®Êñá‰ª∂ÂõæÊ†á
};

export default {
  name: 'App',
  components: { ConfigDialog },
  setup() {
    // --- ÂìçÂ∫îÂºèÊï∞ÊçÆÂÆö‰πâ ---
    const searchQuery = ref(''); // ÊêúÁ¥¢ËæìÂÖ•Ê°ÜÁöÑÂÜÖÂÆπ
    const searchResults = ref([]); // ÊêúÁ¥¢ÁªìÊûúÂàóË°®
    const searchHistory = ref([]); // ÊêúÁ¥¢ÂéÜÂè≤ËÆ∞ÂΩï
    const isSearching = ref(false); // ÊòØÂê¶Ê≠£Âú®ÊâßË°åÊêúÁ¥¢
    const hasSearched = ref(false); // ÊòØÂê¶Â∑≤ÁªèÊâßË°åËøáËá≥Â∞ë‰∏ÄÊ¨°ÊêúÁ¥¢
    const errorMessage = ref(''); // ÈîôËØØ‰ø°ÊÅØ
    const showSuccessMessage = ref(''); // ÊàêÂäüÊ∂àÊÅØ
    const showHistory = ref(false); // ÊòØÂê¶ÊòæÁ§∫ÊêúÁ¥¢ÂéÜÂè≤‰∏ãÊãâÊ°Ü
    const historySelectedIndex = ref(-1); // ÂΩìÂâçÂú®ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÈÄâ‰∏≠ÁöÑÈ°πÁöÑÁ¥¢Âºï
    const showConfigDialog = ref(false); // ÊòØÂê¶ÊòæÁ§∫ÈÖçÁΩÆÂØπËØùÊ°Ü
    const lastSearchQuery = ref(''); // ‰∏ä‰∏ÄÊ¨°Áî®Êà∑ËæìÂÖ•ÁöÑÊü•ËØ¢
    const lastEverythingQuery = ref(''); // ‰∏ä‰∏ÄÊ¨°ÂÆûÈôÖÊâßË°åÁöÑEverythingÊü•ËØ¢
    const everythingConnected = ref(false); // EverythingÊúçÂä°ÊòØÂê¶ËøûÊé•
    const everythingTesting = ref(false); // ÊòØÂê¶Ê≠£Âú®ÊµãËØï‰∏éEverythingÁöÑËøûÊé•
    const isMaximized = ref(false); // Á™óÂè£ÊòØÂê¶ÊúÄÂ§ßÂåñ
    const searchStartTime = ref(0); // ÊêúÁ¥¢ÂºÄÂßãÊó∂Èó¥Êà≥
    const searchDuration = ref(0); // ÊêúÁ¥¢ËÄóÊó∂ÔºàÊØ´ÁßíÔºâ
    const displayFields = ref({ // ÊéßÂà∂ÁªìÊûúÂàóË°®‰∏≠Âì™‰∫õÂàóÊòØÂèØËßÅÁöÑ
      accessed: false, attributes: false, created: false,
      recently_changed: false, run_count: false, file_list_filename: false
    });
    const sortState = reactive({ field: 'name', direction: 'asc' }); // ÊéíÂ∫èÁä∂ÊÄÅ
    const searchInput = ref(null); // ÂØπËæìÂÖ•Ê°ÜDOMÂÖÉÁ¥†ÁöÑÂºïÁî®

    // Ë∞ÉËØïÁõ∏ÂÖ≥Áä∂ÊÄÅ
    const debugConfig = ref({ enableStreamDebug: false }); // Ë∞ÉËØïÈÖçÁΩÆ

    // ÂàóÂÆΩË∞ÉÊï¥Áõ∏ÂÖ≥Áä∂ÊÄÅ
    const columnWidths = ref({
      name: 240,
      path: 320,
      size: 100,
      modified: 140,
      type: 90,
      created: 140,
      accessed: 140,
      attributes: 100,
      run_count: 80
    });
    const isDragging = ref(false);
    const dragColumn = ref('');
    const dragStartX = ref(0);
    const dragStartWidth = ref(0);

    // ÊªöÂä®Êù°Ë°•ÂÅøÁõ∏ÂÖ≥Áä∂ÊÄÅ
    const hasScrollbar = ref(false);
    const fileListBody = ref(null);
    const fileListHeader = ref(null);

    // Ëá™Âä®Êõ¥Êñ∞Áõ∏ÂÖ≥Áä∂ÊÄÅ
    const updateInfo = ref(null); // Êõ¥Êñ∞‰ø°ÊÅØ
    const showUpdateNotification = ref(false); // ÊòæÁ§∫Êõ¥Êñ∞ÈÄöÁü•
    const currentVersion = ref(''); // ÂΩìÂâçÁâàÊú¨

    // --- ËÆ°ÁÆóÂ±ûÊÄß ---

    // Ê†πÊçÆÂΩìÂâçËæìÂÖ•ËøáÊª§ÊêúÁ¥¢ÂéÜÂè≤
    const filteredHistory = computed(() => {
      if (!searchQuery.value.trim()) return searchHistory.value.slice(0, 10); // Êú™ËæìÂÖ•Êó∂ÊòæÁ§∫ÊúÄËøë10Êù°
      return searchHistory.value.filter(item =>
        item.query.toLowerCase().includes(searchQuery.value.toLowerCase())
      ).slice(0, 10);
    });

    // ÂØπÊêúÁ¥¢ÁªìÊûúËøõË°åÊéíÂ∫è
    const sortedResults = computed(() => {
      const { field, direction } = sortState;
      const multiplier = direction === 'asc' ? 1 : -1; // ÂçáÂ∫è‰∏∫1ÔºåÈôçÂ∫è‰∏∫-1
      // ÂàõÂª∫ÂâØÊú¨ËøõË°åÊéíÂ∫èÔºåÈÅøÂÖçÁõ¥Êé•‰øÆÊîπÂéüÂßãÊï∞ÊçÆ
      return [...searchResults.value].sort((a, b) => {
        let aValue = a[field];
        let bValue = b[field];
        // Ê†πÊçÆ‰∏çÂêåÂ≠óÊÆµÁ±ªÂûãËøõË°åÊØîËæÉ
        switch (field) {
          case 'size':
          case 'run_count':
            return ((parseInt(aValue) || 0) - (parseInt(bValue) || 0)) * multiplier;
          case 'modified':
          case 'created':
          case 'accessed':
            return ((new Date(aValue).getTime() || 0) - (new Date(bValue).getTime() || 0)) * multiplier;
          default: // ÈªòËÆ§‰∏∫Â≠óÁ¨¶‰∏≤ÊØîËæÉ
            // ‰ΩøÁî® localeCompare ËøõË°åÊõ¥ÂáÜÁ°ÆÁöÑÊú¨Âú∞ÂåñÂ≠óÁ¨¶‰∏≤ÊéíÂ∫è
            return String(aValue).localeCompare(String(bValue), 'zh-CN', { sensitivity: 'base' }) * multiplier;
        }
      });
    });

         // ËÆ°ÁÆóEverythingËøûÊé•Áä∂ÊÄÅÁöÑCSSÁ±ª
     const everythingStatusClass = computed(() => {
       if (everythingTesting.value) return 'connecting';
       return everythingConnected.value ? 'connected' : 'disconnected';
     });

     // ËÆ°ÁÆóEverythingËøûÊé•Áä∂ÊÄÅÁöÑÊòæÁ§∫ÊñáÊú¨
     const everythingStatusText = computed(() => {
       if (everythingTesting.value) return 'ËøûÊé•‰∏≠';
       return everythingConnected.value ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•';
     });

     // --- ÊñπÊ≥ï ---

    /**
     * ÊâßË°åÊêúÁ¥¢Êìç‰Ωú
     */
    const performSearch = async () => {
      const query = searchQuery.value.trim();
      if (!query) return;

      searchInput.value?.blur(); // ‰ºòÂåñÁÇπ: ÊêúÁ¥¢Êó∂ËÆ©ËæìÂÖ•Ê°ÜÂ§±ÁÑ¶
      isSearching.value = true;
      errorMessage.value = ''; // ÊØèÊ¨°Êñ∞ÊêúÁ¥¢ÂâçÊ∏ÖÈô§ÊóßÈîôËØØ
      hasSearched.value = true;
      lastSearchQuery.value = query;
      searchStartTime.value = Date.now();
      searchResults.value = []; // Á´ãÂç≥Ê∏ÖÁ©∫ÊóßÁªìÊûúÔºå‰ª•Ëß¶ÂèëÂä†ËΩΩÁä∂ÊÄÅ

      // Ë∞ÉËØïÊ®°ÂºèÔºöÂÖàÊ∏ÖÁ©∫ÊóßÁöÑË∞ÉËØïËæìÂá∫
      if (debugConfig.value.enableStreamDebug) {
        clearDebugOutput();
      }

      try {
        const result = await window.electronAPI.searchFiles(query, debugConfig.value.enableStreamDebug);
        if (result.success) {
          const results = result.results || [];
          searchResults.value = results;
          lastEverythingQuery.value = result.everythingQuery || query;
          searchDuration.value = Date.now() - searchStartTime.value;

          // Â¶ÇÊûúÊêúÁ¥¢ÁªìÊûú‰∏∫Á©∫ÔºåËÆæÁΩÆ‰∏Ä‰∏™Âª∂Êó∂ÂêéËá™Âä®Ê∏ÖÁ©∫ÊêúÁ¥¢ÂÜÖÂÆπ
          if (results.length === 0) {
            setTimeout(() => {
              // Âè™ÊúâÂú®Ê≤°ÊúâÊñ∞ÁöÑÊêúÁ¥¢Êìç‰ΩúÊó∂ÊâçÊ∏ÖÁ©∫
              if (!isSearching.value && searchResults.value.length === 0) {
                searchQuery.value = '';
                hasSearched.value = false;
                errorMessage.value = '';
              }
            }, 3000); // 3ÁßíÂêéËá™Âä®Ê∏ÖÁ©∫
          }

          await loadSearchHistory(); // ÊàêÂäüÂêéÂà∑Êñ∞ÂéÜÂè≤ËÆ∞ÂΩï
        } else {
          errorMessage.value = result.error || 'ÊêúÁ¥¢Â§±Ë¥•ÔºåÊú™Áü•ÈîôËØØ„ÄÇ';
          searchDuration.value = 0;
        }
      } catch (error) {
        console.error('ÊêúÁ¥¢ÈîôËØØ:', error);
        errorMessage.value = `ÊêúÁ¥¢ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ: ${error.message}`;
        searchDuration.value = 0;
      } finally {
        isSearching.value = false;
        showHistory.value = false;
      }
    };

    /**
     * Ê∏ÖÈô§ÈîôËØØ‰ø°ÊÅØ
     */
    const clearError = () => {
      errorMessage.value = '';
      if (searchResults.value.length === 0) {
        hasSearched.value = false; // ÈáçÁΩÆÊêúÁ¥¢Áä∂ÊÄÅÔºåËøîÂõûÂàùÂßãÊ¨¢ËøéÁïåÈù¢
      }
    };

    /**
     * ‰ªéÂêéÁ´ØÂä†ËΩΩÊêúÁ¥¢ÂéÜÂè≤
     */
    const loadSearchHistory = async () => {
      try {
        searchHistory.value = await window.electronAPI.getSearchHistory() || [];
      } catch (error) { console.error('Âä†ËΩΩÊêúÁ¥¢ÂéÜÂè≤Â§±Ë¥•:', error); }
    };

    /**
     * ‰ªéÂêéÁ´ØÂä†ËΩΩÂàóÊòæÁ§∫ÈÖçÁΩÆ
     */
    const loadDisplayFieldsConfig = async () => {
      try {
        const config = await window.electronAPI.getOpenAIConfig();
        if (config?.displayFields) {
          displayFields.value = { ...displayFields.value, ...config.displayFields };
        }
      } catch (error) { console.error('Âä†ËΩΩÂ≠óÊÆµÊòæÁ§∫ÈÖçÁΩÆÂ§±Ë¥•:', error); }
    };

    /**
     * ÁÇπÂáªÂéÜÂè≤ËÆ∞ÂΩïÈ°πÊó∂ÔºåÂ°´ÂÖÖËæìÂÖ•Ê°ÜÂπ∂ÊâßË°åÊêúÁ¥¢
     */
    const selectHistoryItem = (item) => {
      searchQuery.value = item.query;
      showHistory.value = false;
      historySelectedIndex.value = -1;
      nextTick(performSearch); // Âú®‰∏ã‰∏Ä‰∏™DOMÊõ¥Êñ∞Âë®ÊúüÊâßË°åÊêúÁ¥¢
    };

    /**
     * ‰ΩøÁî®‰∏ä‰∏ãÁÆ≠Â§¥Âú®ÊêúÁ¥¢ÂéÜÂè≤‰∏≠ÂØºËà™
     */
    const navigateHistory = (direction) => {
      if (!showHistory.value || filteredHistory.value.length === 0) return;
      historySelectedIndex.value += direction;
      // Âæ™ÁéØÈÄâÊã©
      if (historySelectedIndex.value < 0) {
        historySelectedIndex.value = filteredHistory.value.length - 1;
      } else if (historySelectedIndex.value >= filteredHistory.value.length) {
        historySelectedIndex.value = 0;
      }
      // Êõ¥Êñ∞ËæìÂÖ•Ê°ÜÂÜÖÂÆπ‰∏∫ÈÄâ‰∏≠ÁöÑÂéÜÂè≤ËÆ∞ÂΩï
      if (historySelectedIndex.value >= 0) {
        searchQuery.value = filteredHistory.value[historySelectedIndex.value].query;
      }
    };

    /**
     * Âª∂ËøüÈöêËóèÂéÜÂè≤ËÆ∞ÂΩïÔºå‰ª•‰æøÁÇπÂáª‰∫ã‰ª∂ÂèØ‰ª•Ëß¶Âèë
     */
    const hideHistoryDelayed = () => {
      setTimeout(() => {
        showHistory.value = false;
        historySelectedIndex.value = -1;
      }, 200);
    };

    /**
     * ÂàáÊç¢ÊéíÂ∫èÂ≠óÊÆµÂíåÊñπÂêë
     */
    const sortBy = (field) => {
      if (sortState.field === field) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; // ÂàáÊç¢ÊñπÂêë
      } else {
        sortState.field = field; // ÂàáÊç¢Â≠óÊÆµ
        sortState.direction = 'asc'; // ÈªòËÆ§ÂçáÂ∫è
      }
    };

    /**
     * Ëé∑ÂèñÊéíÂ∫èÊåáÁ§∫Âô®ÁöÑCSSÁ±ª
     */
    const getSortClass = (field) => {
      if (sortState.field !== field) return '';
      return sortState.direction === 'asc' ? 'sort-asc' : 'sort-desc';
    };

    /**
     * ÊâìÂºÄÊñá‰ª∂
     */
    const openFile = (file) => {
      window.electronAPI?.openPath(file.path);
    };

    /**
     * ÊòæÁ§∫Êñá‰ª∂ÁöÑÂè≥ÈîÆ‰∏ä‰∏ãÊñáËèúÂçï
     */
    const showFileContextMenu = (file, event) => {
      // ÈòªÊ≠¢ÊµèËßàÂô®ÈªòËÆ§Âè≥ÈîÆËèúÂçï
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }

      // Ë∞ÉÁî® Electron ÊòæÁ§∫Ëá™ÂÆö‰πâÂè≥ÈîÆËèúÂçï
      window.electronAPI?.showFileContextMenu(file.path);
    };

    /**
     * ÂØºÂá∫ÊêúÁ¥¢ÁªìÊûú
     */
    const exportResults = async () => {
      try {
        const result = await window.electronAPI?.exportResults(sortedResults.value);
        if (result?.success) {
          // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØÔºåÂèØ‰ª•‰ΩøÁî®Áé∞ÊúâÁöÑÁä∂ÊÄÅÊòæÁ§∫Êú∫Âà∂
          console.log('ÂØºÂá∫ÊàêÂäü:', result.message);
          // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†‰∏Ä‰∏™ÊàêÂäüÊèêÁ§∫ÁöÑÁä∂ÊÄÅ
          showSuccessMessage.value = result.message;
          setTimeout(() => {
            showSuccessMessage.value = '';
          }, 3000);
        } else {
          // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
          errorMessage.value = result?.error || 'ÂØºÂá∫Â§±Ë¥•';
          setTimeout(() => {
            errorMessage.value = '';
          }, 3000);
        }
      } catch (error) {
        console.error('ÂØºÂá∫Â§±Ë¥•:', error);
        errorMessage.value = `ÂØºÂá∫ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ: ${error.message}`;
        setTimeout(() => {
          errorMessage.value = '';
        }, 3000);
      }
    };

    /**
     * Ê∏ÖÁ©∫ÂΩìÂâçÊêúÁ¥¢ÁªìÊûúÂíåÁä∂ÊÄÅ
     */
    const clearResults = () => {
      searchResults.value = [];
      hasSearched.value = false;
      errorMessage.value = '';
      searchQuery.value = '';
    };

    /**
     * ÁÇπÂáªÊêúÁ¥¢Âª∫ËÆÆÊó∂ÔºåÂ°´ÂÖÖÂπ∂ÊâßË°åÊêúÁ¥¢
     */
    const trySuggestion = (suggestion) => {
      searchQuery.value = suggestion;
      performSearch();
    };

    /**
     * Ëé∑ÂèñÁî®‰∫éÊòæÁ§∫ÁöÑÊñá‰ª∂ÂêçÔºàÁ°Æ‰øùÂåÖÂê´Êâ©Â±ïÂêçÔºâ
     */
    const getDisplayFileName = (file) => {
      if (!file?.name) return '';
      if (file.extension && file.name.toLowerCase().endsWith(`.${file.extension.toLowerCase()}`)) {
        return file.name;
      }
      return file.extension ? `${file.name}.${file.extension}` : file.name;
    };

    // --- Á™óÂè£ÊéßÂà∂ÊñπÊ≥ï ---
    const minimizeWindow = () => window.electronAPI?.minimizeWindow();
    const toggleMaximize = () => {
      if (window.electronAPI?.toggleMaximize) {
        window.electronAPI.toggleMaximize();
        isMaximized.value = !isMaximized.value;
      }
    };
    const closeWindow = () => window.electronAPI?.closeWindow();

    /**
     * Ê£ÄÊü•‰∏éEverythingÊúçÂä°ÁöÑËøûÊé•Áä∂ÊÄÅ
     */
    const checkEverythingStatus = async () => {
      everythingTesting.value = true;
      try {
        everythingConnected.value = await window.electronAPI.testEverythingConnection();
      } catch (error) {
        everythingConnected.value = false;
      } finally {
        everythingTesting.value = false;
      }
    };

    // --- Ë∞ÉËØïÁõ∏ÂÖ≥ÊñπÊ≥ï ---

    /**
     * ÊâìÂºÄË∞ÉËØïÁ™óÂè£
     */
    const openDebugWindow = async () => {
      try {
        const result = await window.electronAPI.openDebugWindow();
        if (!result.success) {
          console.error('ÊâìÂºÄË∞ÉËØïÁ™óÂè£Â§±Ë¥•:', result.error);
        }
      } catch (error) {
        console.error('ÊâìÂºÄË∞ÉËØïÁ™óÂè£Â§±Ë¥•:', error);
      }
    };

    /**
     * Ê∏ÖÁ©∫Ë∞ÉËØïËæìÂá∫
     */
    const clearDebugOutput = async () => {
      try {
        await window.electronAPI.clearDebugOutput();
      } catch (error) {
        console.error('Ê∏ÖÁ©∫Ë∞ÉËØïËæìÂá∫Â§±Ë¥•:', error);
      }
    };





    /**
     * Âä†ËΩΩË∞ÉËØïÈÖçÁΩÆ
     */
    const loadDebugConfig = async () => {
      try {
        const config = await window.electronAPI.getOpenAIConfig();
        debugConfig.value = {
          enableStreamDebug: config.enableStreamDebug || false
        };

        // Ë∞ÉËØïÈÖçÁΩÆÂ∑≤Âä†ËΩΩ
      } catch (error) {
        console.error('Âä†ËΩΩË∞ÉËØïÈÖçÁΩÆÂ§±Ë¥•:', error);
      }
    };

    /**
     * ÂºÄÂßãÂàóÂÆΩÊãñÊãΩË∞ÉÊï¥
     */
    const startColumnResize = (columnName, event) => {
      if (event.button !== 0) return; // Âè™ÂìçÂ∫îÂ∑¶ÈîÆ
      isDragging.value = true;
      dragColumn.value = columnName;
      dragStartX.value = event.clientX;
      dragStartWidth.value = columnWidths.value[columnName];

      // Ê∑ªÂä†ÂÖ®Â±ÄÊãñÊãΩÊ†∑Âºè
      document.body.classList.add('column-resizing');

      document.addEventListener('mousemove', handleColumnResize);
      document.addEventListener('mouseup', stopColumnResize);
      event.preventDefault();
      event.stopPropagation(); // ÈòªÊ≠¢ÁÇπÂáªÊéíÂ∫è
    };

    /**
     * Â§ÑÁêÜÂàóÂÆΩÊãñÊãΩ
     */
    const handleColumnResize = (event) => {
      if (!isDragging.value) return;

      const deltaX = event.clientX - dragStartX.value;
      const newWidth = Math.max(60, dragStartWidth.value + deltaX);

      columnWidths.value[dragColumn.value] = newWidth;
    };

    /**
     * ÂÅúÊ≠¢ÂàóÂÆΩÊãñÊãΩ
     */
    const stopColumnResize = () => {
      if (isDragging.value) {
        isDragging.value = false;
        dragColumn.value = '';
        // ‰øùÂ≠òÂàóÂÆΩËÆæÁΩÆÂà∞localStorage
        saveColumnWidths();
      }

      // ÁßªÈô§ÂÖ®Â±ÄÊãñÊãΩÊ†∑Âºè
      document.body.classList.remove('column-resizing');

      document.removeEventListener('mousemove', handleColumnResize);
      document.removeEventListener('mouseup', stopColumnResize);
    };

    /**
     * ‰øùÂ≠òÂàóÂÆΩËÆæÁΩÆ
     */
    const saveColumnWidths = () => {
      try {
        localStorage.setItem('file-list-column-widths', JSON.stringify(columnWidths.value));
      } catch (error) {
        console.error('‰øùÂ≠òÂàóÂÆΩËÆæÁΩÆÂ§±Ë¥•:', error);
      }
    };

    /**
     * Âä†ËΩΩÂàóÂÆΩËÆæÁΩÆ
     */
    const loadColumnWidths = () => {
      try {
        const saved = localStorage.getItem('file-list-column-widths');
        if (saved) {
          const parsedWidths = JSON.parse(saved);
          columnWidths.value = { ...columnWidths.value, ...parsedWidths };
        }
      } catch (error) {
        console.error('Âä†ËΩΩÂàóÂÆΩËÆæÁΩÆÂ§±Ë¥•:', error);
      }
    };

    /**
     * Ëé∑ÂèñÂàóÁöÑÊ†∑Âºè
     */
    const getColumnStyle = (columnName) => {
      return {
        width: `${columnWidths.value[columnName]}px`,
        minWidth: `${Math.min(columnWidths.value[columnName], 60)}px`,
        maxWidth: `${columnWidths.value[columnName]}px`,
        flex: 'none'
      };
    };

    /**
     * Ê£ÄÊµãË°®‰ΩìÊòØÂê¶Â≠òÂú®ÊªöÂä®Êù°
     */
    const checkScrollbar = () => {
      nextTick(() => {
        if (fileListBody.value) {
          const element = fileListBody.value;
          const hasVerticalScrollbar = element.scrollHeight > element.clientHeight;
          hasScrollbar.value = hasVerticalScrollbar;
        }
      });
    };

    /**
     * ÂêåÊ≠•Ë°®Â§¥ÂíåË°®‰ΩìÁöÑÊ®™ÂêëÊªöÂä®
     */
    const syncHorizontalScroll = (event) => {
      if (fileListHeader.value && fileListBody.value) {
        if (event.target === fileListBody.value) {
          // Ë°®‰ΩìÊªöÂä®Êó∂ÂêåÊ≠•Ë°®Â§¥
          fileListHeader.value.scrollLeft = event.target.scrollLeft;
        } else if (event.target === fileListHeader.value) {
          // Ë°®Â§¥ÊªöÂä®Êó∂ÂêåÊ≠•Ë°®‰ΩìÔºàÂ¶ÇÊûúÈúÄË¶ÅÊîØÊåÅË°®Â§¥Áõ¥Êé•ÊªöÂä®Ôºâ
          fileListBody.value.scrollLeft = event.target.scrollLeft;
        }
      }
    };

    /**
     * ËÆæÁΩÆÊ®™ÂêëÊªöÂä®ÂêåÊ≠•
     */
    const setupScrollSync = () => {
      nextTick(() => {
        if (fileListBody.value) {
          // ‰∏∫Ë°®‰ΩìÊ∑ªÂä†ÊªöÂä®‰∫ã‰ª∂ÁõëÂê¨Âô®
          fileListBody.value.addEventListener('scroll', syncHorizontalScroll);
        }
      });
    };

    /**
     * Ê∏ÖÁêÜÊªöÂä®ÂêåÊ≠•‰∫ã‰ª∂ÁõëÂê¨Âô®
     */
    const cleanupScrollSync = () => {
      if (fileListBody.value) {
        fileListBody.value.removeEventListener('scroll', syncHorizontalScroll);
      }
    };

    /**
     * Ëé∑ÂèñË°®Â§¥ÁöÑÊ†∑ÂºèÔºåÂåÖÂê´ÊªöÂä®Êù°Ë°•ÂÅø
     */
    const getHeaderStyle = computed(() => {
      return {
        paddingRight: hasScrollbar.value ? '6px' : '0px'
      };
    });

    // --- Ëá™Âä®Êõ¥Êñ∞Áõ∏ÂÖ≥ÊñπÊ≥ï ---

    /**
     * Â§ÑÁêÜÊõ¥Êñ∞ÈÄöÁü•
     */
    const handleUpdateNotification = (data) => {
      console.log('Â§ÑÁêÜÊõ¥Êñ∞ÈÄöÁü•ÔºåÊï∞ÊçÆ:', data);
      if (data.hasUpdate) {
        console.log('ËÆæÁΩÆÊõ¥Êñ∞‰ø°ÊÅØÂπ∂ÊòæÁ§∫ÈÄöÁü•');
        updateInfo.value = data;
        showUpdateNotification.value = true;
        console.log('showUpdateNotification.value ËÆæÁΩÆ‰∏∫:', showUpdateNotification.value);
        console.log('updateInfo.value ËÆæÁΩÆ‰∏∫:', updateInfo.value);
      } else {
        console.log('Êï∞ÊçÆ‰∏≠ hasUpdate ‰∏∫ false');
      }
    };

    /**
     * ÂÖ≥Èó≠Êõ¥Êñ∞ÈÄöÁü•
     */
    const closeUpdateNotification = () => {
      showUpdateNotification.value = false;
    };

    /**
     * Á´ãÂç≥‰∏ãËΩΩÊõ¥Êñ∞
     */
    const downloadUpdate = async () => {
      if (updateInfo.value?.downloadUrl) {
        try {
          await window.electronAPI.openDownloadPage(updateInfo.value.downloadUrl);
          closeUpdateNotification();
        } catch (error) {
          console.error('ÊâìÂºÄ‰∏ãËΩΩÈ°µÈù¢Â§±Ë¥•:', error);
        }
      }
    };

    /**
     * Á®çÂêéÊèêÈÜí
     */
    const remindLater = () => {
      closeUpdateNotification();
      // 30ÂàÜÈíüÂêéÂÜçÊ¨°ÊòæÁ§∫
      setTimeout(() => {
        if (updateInfo.value?.hasUpdate) {
          showUpdateNotification.value = true;
        }
      }, 30 * 60 * 1000); // 30ÂàÜÈíü
    };

    /**
     * ÂøΩÁï•Ê≠§ÁâàÊú¨
     */
    const ignoreVersion = () => {
      if (updateInfo.value?.latestVersion) {
        // Â∞ÜÂøΩÁï•ÁöÑÁâàÊú¨Âè∑‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
        try {
          localStorage.setItem('ignored-version', updateInfo.value.latestVersion);
        } catch (error) {
          console.error('‰øùÂ≠òÂøΩÁï•ÁâàÊú¨Â§±Ë¥•:', error);
        }
      }
      closeUpdateNotification();
    };

    /**
     * Ê£ÄÊü•ÊòØÂê¶Â∫îËØ•ÊòæÁ§∫Êõ¥Êñ∞ÈÄöÁü•
     */
    const shouldShowUpdateNotification = (version) => {
      try {
        const ignoredVersion = localStorage.getItem('ignored-version');
        console.log('ÂøΩÁï•ÁöÑÁâàÊú¨:', ignoredVersion, 'ÂΩìÂâçÁâàÊú¨:', version);
        const result = !ignoredVersion || ignoredVersion !== version;
        console.log('shouldShowUpdateNotification ÁªìÊûú:', result);
        return result;
      } catch (error) {
        console.error('Ê£ÄÊü•Êõ¥Êñ∞ÈÄöÁü•ÊòæÁ§∫Áä∂ÊÄÅÂ§±Ë¥•:', error);
        return true;
      }
    };

    /**
     * Ëé∑ÂèñÂΩìÂâçÁâàÊú¨Âè∑
     */
    const loadCurrentVersion = async () => {
      try {
        currentVersion.value = await window.electronAPI.getCurrentVersion();
        console.log('ÂΩìÂâçÁâàÊú¨:', currentVersion.value);
      } catch (error) {
        console.error('Ëé∑ÂèñÂΩìÂâçÁâàÊú¨Â§±Ë¥•:', error);
      }
    };

    /**
     * ÊâãÂä®Ê£ÄÊü•Êõ¥Êñ∞ÔºàÁî®‰∫éË∞ÉËØïÔºâ
     */
    const manualCheckForUpdates = async () => {
      try {
        console.log('ÊâãÂä®Ëß¶ÂèëÊ£ÄÊü•Êõ¥Êñ∞...');
        const result = await window.electronAPI.checkForUpdates();
        console.log('ÊâãÂä®Ê£ÄÊü•Êõ¥Êñ∞ÁªìÊûú:', result);
        if (result.hasUpdate) {
          handleUpdateNotification(result);
        }
      } catch (error) {
        console.error('ÊâãÂä®Ê£ÄÊü•Êõ¥Êñ∞Â§±Ë¥•:', error);
      }
    };

    // Âú®ÂºÄÂèëÁéØÂ¢É‰∏ãÊö¥Èú≤Âà∞ÂÖ®Â±ÄÔºåÊñπ‰æøË∞ÉËØï
    if (process.env.NODE_ENV === 'development') {
      window.debugUpdateNotification = {
        manualCheck: manualCheckForUpdates,
        showNotification: () => {
          updateInfo.value = {
            hasUpdate: true,
            currentVersion: '1.0.0',
            latestVersion: '2.0.0',
            releaseNotes: 'ËøôÊòØ‰∏Ä‰∏™ÊµãËØïÊõ¥Êñ∞ÈÄöÁü•',
            downloadUrl: 'https://github.com',
            publishedAt: new Date().toISOString()
          };
          showUpdateNotification.value = true;
        },
        hideNotification: () => {
          showUpdateNotification.value = false;
        }
      };
    }

    // --- ÁõëÂê¨Âô® ---

    // ÁõëÂê¨ÊêúÁ¥¢ÁªìÊûúÂèòÂåñÔºåÊ£ÄÊµãÊªöÂä®Êù°Áä∂ÊÄÅÂπ∂ÈáçÊñ∞ËÆæÁΩÆÊªöÂä®ÂêåÊ≠•
    watch(searchResults, () => {
      checkScrollbar();
      setupScrollSync(); // ÈáçÊñ∞ËÆæÁΩÆÊªöÂä®ÂêåÊ≠•ÔºåÁ°Æ‰øùÊñ∞ÁöÑDOMÂÖÉÁ¥†Ê≠£Á°ÆÁªëÂÆö‰∫ã‰ª∂
    }, { flush: 'post' });

    // --- ÁîüÂëΩÂë®ÊúüÈí©Â≠ê ---

    // Á™óÂè£Â§ßÂ∞èÂèòÂåñÂ§ÑÁêÜÂáΩÊï∞
    const handleResize = () => {
      checkScrollbar();
    };

    onMounted(() => {
      // ÁªÑ‰ª∂ÊåÇËΩΩÂêéÔºåÂä†ËΩΩÂàùÂßãÊï∞ÊçÆ
      loadSearchHistory();
      loadDisplayFieldsConfig();
      loadColumnWidths(); // Âä†ËΩΩÂàóÂÆΩËÆæÁΩÆ
      loadDebugConfig(); // Âä†ËΩΩË∞ÉËØïÈÖçÁΩÆ
      checkEverythingStatus();
      // ÂÆöÊúüÊ£ÄÊü•EverythingËøûÊé•Áä∂ÊÄÅ
      setInterval(checkEverythingStatus, 30000); // ÊØè30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°

      // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñÔºåÈáçÊñ∞Ê£ÄÊµãÊªöÂä®Êù°
      window.addEventListener('resize', handleResize);

      // ËÆæÁΩÆÊ®™ÂêëÊªöÂä®ÂêåÊ≠•
      setupScrollSync();

      // ÁõëÂê¨Êù•Ëá™‰∏ªËøõÁ®ãÁöÑÊ∂àÊÅØ
      if (window.electronAPI?.on) {
        console.log('ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®...');

        window.electronAPI.on('open-settings', () => {
          showConfigDialog.value = true;
        });

        // Ë∞ÉËØïÁõ∏ÂÖ≥‰∫ã‰ª∂Â∑≤ÁßªÂä®Âà∞Áã¨Á´ãÁöÑË∞ÉËØïÁ™óÂè£‰∏≠Â§ÑÁêÜ

        // ÁõëÂê¨ÈÖçÁΩÆÊõ¥Êñ∞‰∫ã‰ª∂
        window.electronAPI.on('config-updated', (data) => {
          console.log('Êî∂Âà∞ÈÖçÁΩÆÊõ¥Êñ∞ÈÄöÁü•:', data);
          if (data.type === 'openai') {
            // ÈáçÊñ∞Âä†ËΩΩË∞ÉËØïÈÖçÁΩÆ
            loadDebugConfig();
          }
        });

        // ÁõëÂê¨Ëá™Âä®Êõ¥Êñ∞ÈÄöÁü•
        console.log('ËÆæÁΩÆ update-available ‰∫ã‰ª∂ÁõëÂê¨Âô®...');
        window.electronAPI.on('update-available', (data) => {
          console.log('Êî∂Âà∞Êõ¥Êñ∞ÈÄöÁü•:', data);
          // Ê£ÄÊü•ÊòØÂê¶Â∫îËØ•ÊòæÁ§∫Ê≠§ÁâàÊú¨ÁöÑÊõ¥Êñ∞ÈÄöÁü•
          const shouldShow = shouldShowUpdateNotification(data.latestVersion);
          console.log('ÊòØÂê¶Â∫îËØ•ÊòæÁ§∫Êõ¥Êñ∞ÈÄöÁü•:', shouldShow);
          if (shouldShow) {
            console.log('ÊòæÁ§∫Êõ¥Êñ∞ÈÄöÁü•');
            handleUpdateNotification(data);
          } else {
            console.log('Â∑≤ÂøΩÁï•Ê≠§ÁâàÊú¨Êõ¥Êñ∞ÈÄöÁü•');
          }
        });
        console.log('update-available ‰∫ã‰ª∂ÁõëÂê¨Âô®ËÆæÁΩÆÂÆåÊàê');
      }

      // Âä†ËΩΩÂΩìÂâçÁâàÊú¨Âè∑
      loadCurrentVersion();
    });

    // ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
    onBeforeUnmount(() => {
      window.removeEventListener('resize', handleResize);
      cleanupScrollSync(); // Ê∏ÖÁêÜÊªöÂä®ÂêåÊ≠•‰∫ã‰ª∂ÁõëÂê¨Âô®
    });

    // ËøîÂõûÊâÄÊúâÈúÄË¶ÅÂú®Ê®°Êùø‰∏≠‰ΩøÁî®ÁöÑÊï∞ÊçÆÂíåÊñπÊ≥ï
    return {
      // Êï∞ÊçÆ
      searchQuery, searchResults, searchHistory, isSearching, hasSearched, errorMessage, showSuccessMessage,
      showHistory, historySelectedIndex, showConfigDialog, lastSearchQuery, lastEverythingQuery,
      searchInput, displayFields, everythingConnected, everythingTesting, isMaximized, searchDuration,
      // Ë∞ÉËØïÁõ∏ÂÖ≥Êï∞ÊçÆ
      debugConfig,
      // ÂàóÂÆΩË∞ÉÊï¥Áõ∏ÂÖ≥Êï∞ÊçÆ
      columnWidths, isDragging, dragColumn,
      // ÊªöÂä®Êù°Ë°•ÂÅøÁõ∏ÂÖ≥Êï∞ÊçÆ
      hasScrollbar, fileListBody, fileListHeader,
      // Ëá™Âä®Êõ¥Êñ∞Áõ∏ÂÖ≥Êï∞ÊçÆ
      updateInfo, showUpdateNotification, currentVersion,
      // ËÆ°ÁÆóÂ±ûÊÄß
      filteredHistory, sortedResults, everythingStatusClass, everythingStatusText, getHeaderStyle,
      // ÊñπÊ≥ï
      performSearch, selectHistoryItem, navigateHistory, hideHistoryDelayed, sortBy, getSortClass,
      openFile, showFileContextMenu, exportResults, clearResults, trySuggestion,
      minimizeWindow, toggleMaximize, closeWindow, checkEverythingStatus,
      // Ë∞ÉËØïÁõ∏ÂÖ≥ÊñπÊ≥ï
      openDebugWindow, clearDebugOutput, loadDebugConfig,
      // ÂàóÂÆΩË∞ÉÊï¥ÊñπÊ≥ï
      startColumnResize, getColumnStyle,
      // ÊªöÂä®Êù°Ê£ÄÊµãÊñπÊ≥ï
      checkScrollbar,
      // Ëá™Âä®Êõ¥Êñ∞Áõ∏ÂÖ≥ÊñπÊ≥ï
      handleUpdateNotification, closeUpdateNotification, downloadUpdate, remindLater, ignoreVersion,
      // Êñ∞Â¢ûÂíåÂ§ñÈÉ®ÊñπÊ≥ï
      clearError, formatFileSize, formatDate, getFileIcon, getDisplayFileName
    };
  }
};
</script>

<style scoped>
/* Ë∞ÉËØïÊéßÂà∂Ê†èÊ†∑Âºè */
.debug-controls-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 16px;
  background: #f5f5f5;
  border-top: 1px solid #e0e0e0;
  border-bottom: 1px solid #e0e0e0;
  margin-bottom: 8px;
}

.debug-info .debug-status {
  color: #616161;
  font-weight: 500;
  font-size: 14px;
}

.debug-actions {
  display: flex;
  gap: 8px;
}

.debug-action-button {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: #e5613a;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.debug-action-button:hover {
  background: #d14c2a;
  transform: translateY(-1px);
}

.debug-action-button .button-icon {
  font-size: 14px;
}
</style>
